#!/usr/bin/env node
var args = require('minimist')(process.argv)
var cmd = args._[2] || 'status';
var Clock = require('../index').Clock;
var fs = require('fs')
var path = require('path')
var clockDir = path.join(process.cwd(), '.clock')
var myName = process.env.USER
var myTimeFile = path.join(clockDir, myName)
var clockDirExists = fs.existsSync(clockDir)
var myTimeFileExists = fs.existsSync(myTimeFile)

function die(msg) {
  console.error(msg)
  process.exit(0);
}

if (!clockDirExists && cmd !== 'in') {
  die('No .clock directory exists in current directory. `dotclock in` to create it and clock in at the same time.')
}

if (cmd === 'in') {
  if (clockDirExists) {
    clockIn()
  } else {
    createDatabase()
    clockIn()
  }
} else if (cmd === 'out') {
  clockOut()
} else if (cmd === "export") {
  exportSessions(args)
} else if (!cmd || cmd === "status") {
  printStatus()
}

function createDatabase() {
  console.log('Creating', clockDir);
  fs.mkdirSync(clockDir);
}

function clockIn() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
  } else {
    // create new struct in mem
    clock.load({ sessions: [] })
  }
  if (clock.isOn()) {
    // throw if session already open
    die("You're already clocked in. You must first clock `out`");
  } else {
    // open a new session
    clock.openNewSession();
    // write back file as json
    clock.persistToPath(myTimeFile)
    console.log('Clocked in');
  }
}

function clockOut() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    if (clock.isOn()) {
      var last = clock.getLastSession()
      // close last session by updating keys "end"
      last.end();
      // write back file as json
      clock.persistToPath(myTimeFile)
      console.log("You clocked out after", last.diff('hours'), 'hours')
    } else {
      console.log("Not clocked in")
    }
  } else {
    // throw error saying you never clocked in
    die("You have never clocked in")
  }
}

function printStatus() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    if (clock.isOn()) {
      var last = clock.getLastSession()
      // print session details
      console.log("Clocked in on", last.formatStartTime("dddd, MMMM Do YYYY, h:mm:ss a"))
      console.log("You've been clocked in for", last.diff('hours'), 'hours')
    } else {
      console.log("Not clocked in")
    }
  } else {
    // throw error saying you never clocked in
    console.log("Never clocked in")
  }
}

function exportSessions(opts) {
  var clock = new Clock();
  if (myTimeFileExists) {
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    console.log('Name\tStart Timestamp\tEnd Timestamp\tHours')
    clock.getSessions().forEach(function(session) {
      var start = session.formatStartTime("YYYY-MM-DD HH:mm")
      var end = session.formatEndTime("YYYY-MM-DD HH:mm")
      var hours = session.diff('hours')
      if (opts.git && opts.granular) {
        var commits = session.commits();
        console.log(myName+'\t'+start+'\t'+end+'\t'+hours+'\n'+commits);
      } else {
        console.log(myName+'\t'+start+'\t'+end+'\t'+hours);
      }
    })
    if (opts.git && !opts.granular) {
      console.log(clock.commits())
    }
  } else {
    console.log("Never clocked in")
  }
}
