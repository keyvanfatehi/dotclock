#!/usr/bin/env node
var args = require('minimist')(process.argv)
var cmd = args._[2] || 'status';
var Clock = require('../index').Clock;
var fs = require('fs')
var path = require('path')
var clockDir = path.join(process.cwd(), '.clock')
var myName = process.env.USER
var myTimeFile = path.join(clockDir, myName)
var clockDirExists = fs.existsSync(clockDir)
var myTimeFileExists = fs.existsSync(myTimeFile)

function die(msg) {
  console.error(msg)
  process.exit(0);
}

if (!clockDirExists && cmd !== 'in') {
  die('No .clock directory exists in current directory. `dotclock in` to create it and clock in at the same time.')
}

if (cmd === 'in') {
  if (!clockDirExists) createDatabase();
  clockIn()
} else if (cmd === 'out') {
  clockOut()
} else if (cmd === "export") {
  exportSessions(args)
} else if (!cmd || cmd === "status") {
  printStatus()
} else {
  console.log(require('../lib/help'));
}

function createDatabase() {
  console.log('Creating', clockDir);
  fs.mkdirSync(clockDir);
}

function clockIn() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
  } else {
    // create new struct in mem
    clock.load({ sessions: [] })
  }
  if (clock.isOn()) {
    // throw if session already open
    die("You're already clocked in. You must first clock `out`");
  } else {
    // open a new session
    clock.openNewSession();
    // write back file as json
    clock.persistToPath(myTimeFile)
    console.log('Clocked in');
  }
}

function clockOut() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    if (clock.isOn()) {
      var last = clock.getLastSession()
      // close last session by updating keys "end"
      last.end();
      // write back file as json
      clock.persistToPath(myTimeFile)
      console.log("You clocked out after", last.diff('hours'), 'hours')
    } else {
      console.log("Not clocked in")
    }
  } else {
    // throw error saying you never clocked in
    die("You have never clocked in")
  }
}

function printStatus() {
  var clock = new Clock();
  if (myTimeFileExists) {
    // parse that json into mem
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    if (clock.isOn()) {
      var last = clock.getLastSession()
      // print session details
      console.log("Clocked in on", last.formatStartTime("dddd, MMMM Do YYYY, h:mm:ss a"))
      console.log("You've been clocked in for", last.diff('hours'), 'hours')
    } else {
      console.log("Not clocked in")
    }
  } else {
    // throw error saying you never clocked in
    console.log("Never clocked in")
  }
}

function exportSessions(opts) {
  var clock = new Clock();
  if (myTimeFileExists) {
    clock.load(JSON.parse(fs.readFileSync(myTimeFile)))
    var fmt = 'llll'
    clock.getSessions().forEach(function(session) {
      var start = session.formatStartTime(fmt)
      var end = session.formatEndTime(fmt)
      var hours = session.diff('hours')
      var basics = 'in:\t'+start+'\nout:\t'+end+'\nhours:\t'+hours
      if (opts.git && opts.granular) {
        var commits = session.commits();
        var preGit = basics+'\ngit:'
        if (commits.length)
          console.log(preGit+'\n'+commits);
        else
          console.log(preGit+'\tn/a');
      } else
        console.log(basics);
      console.log();
    })
    if (opts.git && !opts.granular) {
      console.log(clock.commits())
    }
  } else {
    console.log("Never clocked in")
  }
}
